# Squid configuration for PCI-Proxy outbound requests
# This handles detokenization when your app makes requests to payment providers

# Basic settings
http_port 3128
cache deny all

# Access control
acl SSL_ports port 443
acl Safe_ports port 80      # http
acl Safe_ports port 443     # https
acl CONNECT method CONNECT

# Only allow HTTPS for payment providers
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Local network access
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
http_access allow localnet

# ICAP configuration for detokenization
icap_enable on
icap_service_revival_delay 30

# Request modification service (detokenization)
icap_service detokenizer reqmod_precache bypass=0 icap://tokenizer:1344/request
adaptation_access detokenizer allow all

# Response modification service (tokenization of responses if needed)
icap_service tokenizer_resp respmod_precache bypass=0 icap://tokenizer:1344/response
adaptation_access tokenizer_resp allow all

# SSL bump configuration to inspect HTTPS traffic
http_port 3129 ssl-bump cert=/etc/squid/certs/squid.pem
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

# Whitelist of payment provider domains
acl payment_providers dstdomain .stripe.com
acl payment_providers dstdomain .paypal.com
acl payment_providers dstdomain .braintreegateway.com
acl payment_providers dstdomain .adyen.com
acl payment_providers dstdomain .square.com
acl payment_providers dstdomain .authorize.net
acl payment_providers dstdomain payment-gateway  # Our dummy gateway

# Only allow connections to whitelisted payment providers
http_access allow payment_providers
http_access deny all

# Logging
access_log /var/log/squid/access.log
cache_log /var/log/squid/cache.log

# Error pages
error_directory /usr/share/squid/errors/

# Performance tuning
maximum_object_size 0 KB
minimum_object_size 0 KB
maximum_object_size_in_memory 0 KB

# DNS
dns_nameservers 8.8.8.8 8.8.4.4

# Forwarding
forwarded_for off
via off

# Headers to remove
request_header_access X-Forwarded-For deny all
reply_header_access X-Squid-Error deny all