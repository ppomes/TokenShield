#!/usr/bin/make -f

export DH_VERBOSE = 1
export DH_GOPKG = tokenshield-cli
export DH_GOLANG_INSTALL_ALL = 1
export DH_GOLANG_GO_GENERATE = 1

# Set build flags for security hardening
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_LDFLAGS_MAINT_APPEND = -Wl,-z,now

%:
	dh $@ --builddirectory=_build --buildsystem=golang

override_dh_auto_clean:
	dh_auto_clean
	rm -rf _build

override_dh_auto_configure:
	dh_auto_configure
	# Copy the source to the build directory
	mkdir -p _build/src/$(DH_GOPKG)
	cp -r cli/* _build/src/$(DH_GOPKG)/

override_dh_auto_build:
	cd _build/src/$(DH_GOPKG) && \
	go mod download && \
	go build -ldflags="-s -w -X main.Version=1.0.0" -o tokenshield main.go

override_dh_auto_test:
	# Skip tests for now - can be enabled later
	# cd _build/src/$(DH_GOPKG) && go test -v ./...

override_dh_auto_install:
	dh_auto_install
	# Install the binary
	install -D -m 0755 _build/src/$(DH_GOPKG)/tokenshield \
		debian/tokenshield-cli/usr/bin/tokenshield
	# Install bash completion
	install -D -m 0644 debian/tokenshield.bash-completion \
		debian/tokenshield-cli/usr/share/bash-completion/completions/tokenshield
	# Install zsh completion
	install -D -m 0644 debian/tokenshield.zsh-completion \
		debian/tokenshield-cli/usr/share/zsh/vendor-completions/_tokenshield
	# Install man page
	install -D -m 0644 debian/tokenshield.1 \
		debian/tokenshield-cli/usr/share/man/man1/tokenshield.1
	# Create config directory
	install -d -m 0755 debian/tokenshield-cli/etc/tokenshield
	# Install example config
	install -D -m 0644 debian/tokenshield.conf.example \
		debian/tokenshield-cli/etc/tokenshield/tokenshield.conf.example

override_dh_strip:
	dh_strip --no-automatic-dbgsym