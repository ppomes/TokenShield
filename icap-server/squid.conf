# Squid configuration for TokenShield ICAP integration

# Basic settings
http_port 3128
cache_dir ufs /var/spool/squid 100 16 256
access_log /var/log/squid/access.log squid

# ICAP Configuration
icap_enable on
icap_send_client_ip on
icap_send_client_username on
icap_client_username_header X-Authenticated-User
icap_preview_enable off
icap_preview_size 0

# Define ICAP service
icap_service tokenshield_reqmod reqmod_precache icap://icap-server:1344/tokenshield
adaptation_access tokenshield_reqmod allow all

# Configure which requests to send to ICAP
# Only send POST/PUT requests with JSON content
acl JSON_CONTENT req_header Content-Type -i application/json
acl POST_PUT method POST PUT PATCH

# Apply ICAP service to JSON requests
adaptation_access tokenshield_reqmod allow POST_PUT JSON_CONTENT
adaptation_access tokenshield_reqmod deny all

# ICAP service settings
icap_service_failure_limit -1
icap_retry_limit 3
icap_retry_interval 5

# Access control
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 1025-65535  # unregistered ports
acl CONNECT method CONNECT

# Deny requests to certain sites
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost

# Allow local networks
http_access allow localnet

# And finally deny all other access
http_access deny all

# Performance tuning
forwarded_for on
client_persistent_connections on
server_persistent_connections on

# Error handling
error_directory /usr/share/squid/errors/en

# Cache settings
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# Logging
cache_log /var/log/squid/cache.log
cache_store_log none

# Process settings
coredump_dir /var/spool/squid

# Shutdown settings
shutdown_lifetime 3 seconds